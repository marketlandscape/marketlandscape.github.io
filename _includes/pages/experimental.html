<!-- grid.html (FULL FILE, PAGE-LOCAL GRID ONLY) -->

<div class="v2 v2-grid" data-lang="{{ page.lang | default: site.lang | default: 'en' }}">

  <div class="indexes">

    <!-- =========================
         BOX 1 — YELLOW
         (top-left)
         ========================= -->
    <div class="cell-box1">
      <div class="entity-box" data-box="1">

        <div class="entity-title">{% include t.html key="index.box1.title" %}</div>

        <picture class="entity-bar" aria-hidden="true">
          <source media="(prefers-color-scheme: dark)" srcset="/assets/img/thin-bar-orange-light.svg">
          <img class="entity-bar-img" src="/assets/img/thin-bar-orange-light.svg" alt="">
        </picture>

        <svg class="entity-frame" viewBox="0 0 360 150" aria-hidden="true">
          <rect class="entity-frame-bg" x="0" y="0" width="360" height="150" rx="14" ry="14"></rect>
          <rect class="entity-frame-stroke" x="0.5" y="0.5" width="359" height="149" rx="13.5" ry="13.5"></rect>
        </svg>

        <div class="entity-steps">
          <span>{% include t.html key="index.step.entry" %}</span>
          <span>{% include t.html key="index.step.scale_in" %}</span>
          <span>{% include t.html key="index.step.hold" %}</span>
          <span>{% include t.html key="index.step.conviction" %}</span>
          <span>{% include t.html key="index.step.hodl" %}</span>
        </div>

        <div class="entity-value" data-role="val">–</div>

        <div class="entity-risk">
          <span class="entity-warn" data-role="warn">⚠</span>
          <span class="entity-risk-label">{% include t.html key="index.risk.label" %}</span>
          <span class="entity-risk-val" data-role="risk">–%</span>
        </div>

        <svg class="entity-dot-layer" viewBox="0 0 360 150" aria-hidden="true">
          <circle class="entity-dot-outer" cx="29.76" cy="121.2" r="9"></circle>
          <circle class="entity-dot-inner" cx="29.76" cy="121.2" r="6"></circle>
        </svg>

      </div>
    </div>

    <!-- =========================
         NAV HISTORY (top-right)
         pre-rendered SVG (no JS)
         ========================= -->
    <div class="cell-history">
      <div class="entity-history-box">

        <img
          class="history-img"
          src="/assets/img/charts/nav_2w.svg"
          alt=""
          loading="eager"
          decoding="async"
        >

        <!-- labels reconstructed from nav-meta in the svg -->
        <div class="nav-xlabels" aria-hidden="true"></div>

        <!-- reuse the same frame style as boxes -->
        <svg class="entity-frame" viewBox="0 0 360 150" aria-hidden="true">
          <rect class="entity-frame-bg" x="0" y="0" width="360" height="150" rx="14" ry="14"></rect>
          <rect class="entity-frame-stroke" x="0.5" y="0.5" width="359" height="149" rx="13.5" ry="13.5"></rect>
        </svg>

      </div>
    </div>

    <!-- =========================
         BOX 2 — BLUE
         (row 2 left)
         ========================= -->
    <div class="cell-box2">
      <div class="entity-box" data-box="2">

        <div class="entity-title">{% include t.html key="index.box2.title" %}</div>

        <picture class="entity-bar" aria-hidden="true">
          <source media="(prefers-color-scheme: dark)" srcset="/assets/img/thin-bar-blue-light.svg">
          <img class="entity-bar-img" src="/assets/img/thin-bar-blue-light.svg" alt="">
        </picture>

        <svg class="entity-frame" viewBox="0 0 360 150" aria-hidden="true">
          <rect class="entity-frame-bg" x="0" y="0" width="360" height="150" rx="14" ry="14"></rect>
          <rect class="entity-frame-stroke" x="0.5" y="0.5" width="359" height="149" rx="13.5" ry="13.5"></rect>
        </svg>

        <div class="entity-steps">
          <span>{% include t.html key="index.step.entry" %}</span>
          <span>{% include t.html key="index.step.scale_in" %}</span>
          <span>{% include t.html key="index.step.hold" %}</span>
          <span>{% include t.html key="index.step.reduce" %}</span>
          <span>{% include t.html key="index.step.exit" %}</span>
        </div>

        <div class="entity-value" data-role="val">–</div>

        <div class="entity-risk">
          <span class="entity-warn" data-role="warn">⚠</span>
          <span class="entity-risk-label">{% include t.html key="index.risk.label" %}</span>
          <span class="entity-risk-val" data-role="risk">–%</span>
        </div>

        <svg class="entity-dot-layer" viewBox="0 0 360 150" aria-hidden="true">
          <circle class="entity-dot-outer" cx="29.76" cy="121.2" r="9"></circle>
          <circle class="entity-dot-inner" cx="29.76" cy="121.2" r="6"></circle>
        </svg>

      </div>
    </div>

    <!-- =========================
         BOX 3 — GREY (experimental title key)
         (row 2 right)
         ========================= -->
    <div class="cell-box3">
      <div class="entity-box" data-box="3">

        <div class="entity-title">
          {% include t.html key="experimental.box3.title" default="Altcoin Navigation Index" %}
        </div>

        <picture class="entity-bar" aria-hidden="true">
          <source media="(prefers-color-scheme: dark)" srcset="/assets/img/thin-bar-grey-light.svg">
          <img class="entity-bar-img" src="/assets/img/thin-bar-grey-light.svg" alt="">
        </picture>

        <svg class="entity-frame" viewBox="0 0 360 150" aria-hidden="true">
          <rect class="entity-frame-bg" x="0" y="0" width="360" height="150" rx="14" ry="14"></rect>
          <rect class="entity-frame-stroke" x="0.5" y="0.5" width="359" height="149" rx="13.5" ry="13.5"></rect>
        </svg>

        <div class="entity-steps">
          <span>{% include t.html key="index.step.entry" %}</span>
          <span>{% include t.html key="index.step.scale_in" %}</span>
          <span>{% include t.html key="index.step.wait" %}</span>
          <span>{% include t.html key="index.step.reduce" %}</span>
          <span>{% include t.html key="index.step.exit" %}</span>
        </div>

        <div class="entity-value" data-role="val">–</div>

        <div class="entity-risk">
          <span class="entity-warn" data-role="warn">⚠</span>
          <span class="entity-risk-label">{% include t.html key="index.risk.label" %}</span>
          <span class="entity-risk-val" data-role="risk">–%</span>
        </div>

        <svg class="entity-dot-layer" viewBox="0 0 360 150" aria-hidden="true">
          <circle class="entity-dot-outer" cx="29.76" cy="121.2" r="9"></circle>
          <circle class="entity-dot-inner" cx="29.76" cy="121.2" r="6"></circle>
        </svg>

      </div>
    </div>

    <!-- =========================
         BOX 4 — GREY (experimental title key)
         (row 3 left)
         ========================= -->
    <div class="cell-box4">
      <div class="entity-box" data-box="4">

        <div class="entity-title">
          {% include t.html key="experimental.box4.title" default="Box 4" %}
        </div>

        <picture class="entity-bar" aria-hidden="true">
          <source media="(prefers-color-scheme: dark)" srcset="/assets/img/thin-bar-grey-light.svg">
          <img class="entity-bar-img" src="/assets/img/thin-bar-grey-light.svg" alt="">
        </picture>

        <svg class="entity-frame" viewBox="0 0 360 150" aria-hidden="true">
          <rect class="entity-frame-bg" x="0" y="0" width="360" height="150" rx="14" ry="14"></rect>
          <rect class="entity-frame-stroke" x="0.5" y="0.5" width="359" height="149" rx="13.5" ry="13.5"></rect>
        </svg>

        <div class="entity-steps">
          <span>{% include t.html key="index.step.entry" %}</span>
          <span>{% include t.html key="index.step.scale_in" %}</span>
          <span>{% include t.html key="index.step.wait" %}</span>
          <span>{% include t.html key="index.step.reduce" %}</span>
          <span>{% include t.html key="index.step.exit" %}</span>
        </div>

        <div class="entity-value" data-role="val">–</div>

        <div class="entity-risk">
          <span class="entity-warn" data-role="warn">⚠</span>
          <span class="entity-risk-label">{% include t.html key="index.risk.label" %}</span>
          <span class="entity-risk-val" data-role="risk">–%</span>
        </div>

        <svg class="entity-dot-layer" viewBox="0 0 360 150" aria-hidden="true">
          <circle class="entity-dot-outer" cx="29.76" cy="121.2" r="9"></circle>
          <circle class="entity-dot-inner" cx="29.76" cy="121.2" r="6"></circle>
        </svg>

      </div>
    </div>

    <!-- =========================
         BOX 5 — GREY (experimental title key)
         (row 3 right)
         ========================= -->
    <div class="cell-box5">
      <div class="entity-box" data-box="5">

        <div class="entity-title">
          {% include t.html key="experimental.box5.title" default="Box 5" %}
        </div>

        <picture class="entity-bar" aria-hidden="true">
          <source media="(prefers-color-scheme: dark)" srcset="/assets/img/thin-bar-grey-light.svg">
          <img class="entity-bar-img" src="/assets/img/thin-bar-grey-light.svg" alt="">
        </picture>

        <svg class="entity-frame" viewBox="0 0 360 150" aria-hidden="true">
          <rect class="entity-frame-bg" x="0" y="0" width="360" height="150" rx="14" ry="14"></rect>
          <rect class="entity-frame-stroke" x="0.5" y="0.5" width="359" height="149" rx="13.5" ry="13.5"></rect>
        </svg>

        <div class="entity-steps">
          <span>{% include t.html key="index.step.entry" %}</span>
          <span>{% include t.html key="index.step.scale_in" %}</span>
          <span>{% include t.html key="index.step.wait" %}</span>
          <span>{% include t.html key="index.step.reduce" %}</span>
          <span>{% include t.html key="index.step.exit" %}</span>
        </div>

        <div class="entity-value" data-role="val">–</div>

        <div class="entity-risk">
          <span class="entity-warn" data-role="warn">⚠</span>
          <span class="entity-risk-label">{% include t.html key="index.risk.label" %}</span>
          <span class="entity-risk-val" data-role="risk">–%</span>
        </div>

        <svg class="entity-dot-layer" viewBox="0 0 360 150" aria-hidden="true">
          <circle class="entity-dot-outer" cx="29.76" cy="121.2" r="9"></circle>
          <circle class="entity-dot-inner" cx="29.76" cy="121.2" r="6"></circle>
        </svg>

      </div>
    </div>

  </div>

  {%- capture fn -%}{% include t.html key="index.footnotes.footnote1" default="" %}{%- endcapture -%}
  {%- assign fn = fn | strip -%}
  {%- if fn != "" -%}
    <div class="index-footnote">
      <span class="fn-mark">*</span>
      {{ fn }}
    </div>
  {%- endif -%}

</div>

<!-- date i18n for chart x-labels (expects DD.MM input) -->
<script src="/assets/js/i18n-date.js"></script>

<script>
function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

function setEntityValue(boxEl, x){
  const n = Number(x);
  if (!Number.isFinite(n)) return;

  const pct = clamp(n, 0, 100);
  const TOTAL = 25;
  const step = Math.round((pct / 100) * (TOTAL - 1)) + 1;

  const START = 23.5;
  const END   = 336.5;
  const BIN   = (END - START) / TOTAL;
  const cx = START + (step - 0.5) * BIN;

  boxEl.querySelector(".entity-dot-outer")?.setAttribute("cx", cx);
  boxEl.querySelector(".entity-dot-inner")?.setAttribute("cx", cx);

  const val = boxEl.querySelector('[data-role="val"]');
  if (val){
    val.innerHTML = step + '<span class="entity-total">/' + TOTAL + '</span>';
  }
}

function setEntityRisk(boxEl, r){
  const n = Number(r);
  if (!Number.isFinite(n)) return;
  const el = boxEl.querySelector('[data-role="risk"]');
  if (el) el.textContent = Math.round(clamp(n, 0, 100)) + "%";
}

function setEntityWarn(boxEl, show){
  const el = boxEl.querySelector('[data-role="warn"]');
  if (el) el.style.visibility = show ? "visible" : "hidden";
}

(function(){
  const KEY = "dashboard_indexes_cache_v6";

  function applyAll(d){
    const boxes = {
      1: document.querySelector('.v2 .entity-box[data-box="1"]'),
      2: document.querySelector('.v2 .entity-box[data-box="2"]'),
      3: document.querySelector('.v2 .entity-box[data-box="3"]'),
      4: document.querySelector('.v2 .entity-box[data-box="4"]'),
      5: document.querySelector('.v2 .entity-box[data-box="5"]')
    };

    // values
    for (const k in boxes){
      const b = boxes[k];
      if (!b) continue;
      if (d['box'+k] !== undefined) setEntityValue(b, d['box'+k]);
      if (d['box'+k+'_risk'] !== undefined) setEntityRisk(b, d['box'+k+'_risk']);
    }

    // warning rules (keep same behaviour style)
    if (boxes[1]) setEntityWarn(boxes[1], false);
    if (boxes[2]) setEntityWarn(boxes[2], Number(d.box2) >= 80);
    if (boxes[3]) setEntityWarn(boxes[3], Number(d.box3) >= 80);
    if (boxes[4]) setEntityWarn(boxes[4], Number(d.box4) >= 80);
    if (boxes[5]) setEntityWarn(boxes[5], Number(d.box5) >= 80);
  }

  async function load(){
    try{
      const cached = sessionStorage.getItem(KEY);
      if (cached) applyAll(JSON.parse(cached));

      const res = await fetch("/data/indexes.json", { cache:"no-store" });
      if (!res.ok) return;
      const data = await res.json();

      applyAll(data);
      sessionStorage.setItem(KEY, JSON.stringify(data));
    }catch(e){}
  }

  document.readyState === "loading"
    ? document.addEventListener("DOMContentLoaded", load)
    : load();
})();

/* =====================================================
   NAV HISTORY label extraction (top-right chart only)
   - render immediately from sessionStorage to avoid flicker
   - fetch + update only if labels changed
   ===================================================== */
(async function(){
  try{
    const svgUrl = "/assets/img/charts/nav_2w.svg";
    const host = document.querySelector(".v2 .nav-xlabels");
    if (!host) return;

    const CACHE_KEY = "nav_labels_cache_2w_v1";

    function render(labels){
      if (!Array.isArray(labels) || labels.length === 0) return;

      const grid = document.querySelector(".v2.v2-grid");
      const lang = (grid?.dataset?.lang || document.documentElement.lang || "en");

      const formatted = labels.map(lab => {
        // expects DD.MM from nav-meta (e.g. "18.01")
        return (typeof window.formatNavDate === "function")
          ? window.formatNavDate(String(lab), lang)
          : String(lab);
      });

      const current = Array.from(host.querySelectorAll("span")).map(s => s.textContent);
      const same = current.length === formatted.length && current.every((v, i) => v === formatted[i]);
      if (same) return;

      host.textContent = "";
      for (const text of formatted){
        const s = document.createElement("span");
        s.textContent = text;
        host.appendChild(s);
      }
      host.style.justifyContent = (formatted.length === 1) ? "center" : "space-between";
    }

    // instant render from cache
    try{
      const cached = sessionStorage.getItem(CACHE_KEY);
      if (cached){
        render(JSON.parse(cached));
      }
    }catch(e){}

    // fetch latest meta, update only if changed
    const res = await fetch(svgUrl, { cache:"no-store" });
    if (!res.ok) return;

    const text = await res.text();
    const doc = new DOMParser().parseFromString(text, "image/svg+xml");

    const desc = doc.querySelector('desc#nav-meta');
    if (!desc) return;

    const meta = JSON.parse(desc.textContent.trim() || "{}");
    const labels = Array.isArray(meta.labels) ? meta.labels : [];
    if (!labels.length) return;

    render(labels);
    try{
      sessionStorage.setItem(CACHE_KEY, JSON.stringify(labels));
    }catch(e){}
  }catch(e){}
})();
</script>
